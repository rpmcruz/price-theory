<!DOCTYPE html>
<html>
<head>
    <title>Arbritage game</title>
    <style>
        #wrap {
            width: 450px;
            margin: 0 auto;
        }
/*        .commodity-square {
            width: 100px;
            height: 50px;
            stroke: black;
            stroke-width: 2px;
            fill: white;
            shape-rendering: crispEdges;
        }
        .commodity-name {
            text-anchor: middle;
            font-weight: bold;
        }
        .commodity-value {
            text-anchor: middle;
        }
        .arrow {
            stroke: black;
            stroke-width: 2px;
            fill: white;
        }
        .arrow:hover {
            fill: black;
            cursor: pointer;
        }
        .arrow-text {
            fill: black;
            font-size: small;
            cursor: default;
        }*/
        svg {
            width: 100%;
            height: 300px;
            background-color: #efefef;
            padding: 10px;
            margin-bottom: 20px;
        }
        svg g {
            cursor: pointer;
        }
        svg g rect.box {
            width: 100px;
            height: 50px;
            transform: translate(-50px, -25px);
            stroke-width: 2px;
        }
        svg g rect.active {
            fill: white;
            stroke: black;
        }
        svg g:hover rect.active {
            fill: black;
        }
        svg g rect.passive {
            stroke: #5454ff;
            fill: #dedeff;
        }
        svg g text.name {
            transform: translate(0, -8px);
        }
        svg g text.value {
            transform: translate(0, 8px);
        }
        svg g text {
            text-anchor: middle;
            dominant-baseline: central;
        }
        svg g:hover text.active {
            fill: white;
        }
        svg line {
            stroke: black;
            stroke-width: 2px;
        }
        svg text.line {
            font-size: small;
        }
        svg text.up {
            transform: translate(0, -18px);
            text-anchor: middle;
            dominant-baseline: text-before-edge;
        }
        svg text.left {
            transform: translate(-4px, 0);
            text-anchor: end;
            dominant-baseline: central;
        }
        svg text.right {
            transform: translate(4px, 0);
            text-anchor: start;
            dominant-baseline: central;
        }
        p {
            text-align: justify;
        }
    </style>
</head>

<body>
<div id="wrap">

<svg />

<p>Difficulty: 
<select onchange="set_difficulty(this.value)">
  <option value="3">Easy</option>
  <option value="4">Hard</option>
</select>
</p>

<p id="goal"></p>

<p>This game illustrates how people can make money on arbritage. This is a barter economy (no money), but you could easily see how this would work in the currency market for instance (where too there is no measure of account and so can be seen as a barter economy) or even the stockmarket. In the long run, this bidding of prices up and down regulates prices.</p>
</div>

<script>
var commodities = [
    [
        ['Ivory', 'Wine', 'Spices', 'Silk'],
        ['kg', 'l', 'mg', 'g'],
        'right', 'commodity',
        'These represent some of the most traded commodities in the ancient world <a href="https://en.wikipedia.org/wiki/Ancient_maritime_history">[ref]</a>.'
    ],
    [
        ['Crude Oil', 'Coffee', 'Natural Gas', 'Gold'],
        ['bbl', 'lb', 'BTU', 'oz'],
        'right', 'commodity',
        'These are the most traded commodities in the world as of 2011 <a href="http://artasharakelyan.blogspot.pt/2011/10/top-5-most-traded-commodities-in-world.html">[ref]</a>.'
    ],
    [
        ['US Dollar', 'Euro', 'Japanese Yen', 'British Pound'],
        ['$', '\u20AC', '\u00A5', '\u00A3'],
        'left', 'currency',
        'These are the most traded currencies in the world <a href="http://www.bis.org/publ/rpfx13fx.pdf">[ref]</a>.'
    ],
];

var placements = [
    [[50, 25], [400, 25], [225, 275]],
    [[50, 25], [400, 25], [50, 275], [400, 275]],
];

var svg = document.getElementsByTagName('svg')[0];

function randint(min, max) {
    return Math.floor((Math.random() * (max-min+1)) + min);
}

function greatest_common_divisor(a, b) {  // euclid's algorithm
    if(b == 0)
        return a;
    return greatest_common_divisor(b, a % b);
}

var commodity;
var quantities, prices;
var groups, text, active;

function init(nodes) {
    // initialize variables

    quantities = new Array(nodes);
    quantities[0] = 100;
    for(var i = 1; i < nodes; i++)
        quantities[i] = 0;

    prices = new Array(nodes);
    for(var i = 0; i < nodes; i++) {
        prices[i] = new Array(nodes);
        for(var j = 0; j < nodes; j++) {
            if(i == j)
                prices[i][j] = 1;
            else {
                prices[i][j] = randint(1, 5);
                if(i > j) {
                    var gcd = greatest_common_divisor(prices[i][j], prices[j][i]);
                    prices[i][j] /= gcd;
                    prices[j][i] /= gcd;
                }
            }
        }
    }

    // initialize graphics

    while(svg.lastChild)
        svg.removeChild(svg.lastChild);

    var pos = placements[nodes-3];
    commodity = commodities[Math.floor(Math.random() * commodities.length)];
    groups = new Array(nodes);
    text = new Array(nodes);
    active = 0;

    for(var i = 0; i < nodes; i++) {
        for(var j = i+1; j < nodes; j++) {
            var e = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            e.setAttribute('x1', pos[i][0]);
            e.setAttribute('y1', pos[i][1]);
            e.setAttribute('x2', pos[j][0]);
            e.setAttribute('y2', pos[j][1]);
            svg.appendChild(e);

            e = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            e.classList.add('line');
            if(pos[i][1] == pos[j][1])
                e.classList.add('up');
            else if(pos[i][0] < 450/2)
                e.classList.add(pos[i][0] == pos[j][0] ? 'right' : 'left');
            else
                e.classList.add(pos[i][0] == pos[j][0] ? 'left' : 'right');
            if(commodity[2] == 'left')
                e.textContent = commodity[1][i] + ' ' + prices[j][i] + ' = ' + commodity[1][j] + ' ' + prices[i][j];
            else
                e.textContent = prices[j][i] + ' ' + commodity[1][i] + ' = ' + prices[i][j] + ' ' + commodity[1][j];
            e.setAttribute('x', (pos[i][0]+pos[j][0])/2);
            e.setAttribute('y', (pos[i][1]+pos[j][1])/2);
            svg.appendChild(e);
        }

        var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        var status = i == active ? 'passive' : 'active';
        g.addEventListener('click', function() { node_clicked(event); }, false);

        var e = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        e.classList.add('box');
        e.classList.add(status);
        e.setAttribute('x', pos[i][0]);
        e.setAttribute('y', pos[i][1]);
        g.appendChild(e);

        e = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        e.classList.add('name');
        e.classList.add(status);
        e.textContent = commodity[0][i];
        e.setAttribute('x', pos[i][0]);
        e.setAttribute('y', pos[i][1]);
        g.appendChild(e);

        e = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        e.classList.add('value');
        e.classList.add(status);
        e.textContent = '0 ' + commodity[1][i];
        e.setAttribute('x', pos[i][0]);
        e.setAttribute('y', pos[i][1]);
        g.appendChild(e);

        text[i] = e;
        groups[i] = g;
        svg.appendChild(g);
    }

    document.getElementById('goal').innerHTML = commodity[4] + ' You must obtain 40 units of each ' + commodity[3] + ' by finding arbritage opportunities to finish the game.';
}

function sync() {
    for(var i = 0; i < text.length; i++) {
        if(commodity[2] == 'left')
            text[i].textContent = commodity[1][i] + ' ' + quantities[i].toFixed();
        else
            text[i].textContent = quantities[i].toFixed() + ' ' + commodity[1][i];
        for(var k = 0; k < groups[i].children.length; k++) {
            groups[i].children[k].classList.remove(i == active ? 'active' : 'passive');
            groups[i].children[k].classList.add(i == active ? 'passive' : 'active');
        }
    }
}

init(3);
sync();

function node_clicked(event) {
    var i = active;
    var j;
    // ugly way to get id of clicked object
    for(j = 0; ; j++)
        if(groups[j] == event.target.parentNode)
            break;
    quantities[j] = (prices[i][j] * quantities[i]) / prices[j][i];
    quantities[i] = 0;
    active = j;
    sync();
}

function set_difficulty(level) {
    init(level);
    sync();
}
</script>
</body>
</html>
