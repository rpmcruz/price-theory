<!DOCTYPE html>
<html>
<head>
<title>Elasticity game</title>
<style>
#plot {display:inline-block; font-size:14px;}
.axis path, .axis line {fill:none; stroke:#000; shape-rendering:crispEdges;}
table {display:inline-block;}
tr {margin-bottom: 10px; transition:background-color 200ms;}
tr.hl {background-color: rgb(220,220,220);}
td {border-style:solid; border-width: 1px;}
td.point {font-weight: bold;}
</style>
</head>

<body>
<div id="plot"></div>
<table></table>

<p id="text">Error: make sure you have Javascript enabled and your browser is updated.</p>

<script src="d3.min.js"></script>
<script>
var labels = ['Weather', 'Fashion', 'Meat Price'];
var L1 = ['Terrible', 'Bad', 'Good', 'Great'];
var L2 = ['Last Year', 'No', 'Yes', 'Very hip'];
var L3 = ['$1.00', '$2.00', '$3.00', '$4.00'];

// S=supply, D=demand, P=price
// Qs(P) = a0 + (a1*X0 + a2*X2)*P
// Qd(P) = b0  + (b1*X1  + b2*X2)*P

var A = [0, 2, 0, 1];
var B = [100, 0, -2, -1];

function mult(v, u) {
    var r = new Array(v.length);
    for(var i = 0; i < v.length; i++)
        r[i] = v[i]*u[i];
    return r;
}

function P(X, A, B) {
    var XA = mult(X, A);
    var XB = mult(X, B);
    return (XB[0]-XA[0]) / (XA[1]+XA[2]+XA[3]-(XB[1]+XB[2]+XB[3]));
}

function Q(X, A, B) {
    var XA = mult(X, A);
    var XB = mult(X, B);
    return XA[0] + (XA[1]+XA[2]+XA[3])*P(X, A, B);
}

var idx = d3.shuffle(d3.range(Math.pow(4, 3))).slice(0, 6);
var Xs = idx.map(function(i) {
    return [1, (i%4), (Math.floor(i/4)%4), Math.floor(i/16)];
});

var Qmax = Q([1,3,0,0],A,B);
var Pmax = P([1,3,0,0],A,B);

// CREATE TABLE

var table = d3.select('table');

var tr = table.append('tr');
tr.append('th').html('Point');
tr.append('th').html('Weather');
tr.append('th').html('Fashion');
tr.append('th').html('Meat Price');

function addPoints(Xs) {
    // table
    var tr = table.selectAll('tr.value').data(Xs)
        .enter()
        .append('tr')
        .attr('class', 'value')
        .on('mouseover', function(d, i) {
            this.className = 'hl';
            var g = svg.selectAll('.point')[0][i];
            var t = g.childNodes[0];
            d3.select(t).transition().duration(200).attr('r', 6);
            t = g.childNodes[1];
            d3.select(t).style('font-weight', 'bold');
        })
        .on('mouseout', function(d, i) {       
            this.className = '';
            var g = svg.selectAll('.point')[0][i];
            var t = g.childNodes[0];
            d3.select(t).transition().duration(200).attr('r', 4);
            t = g.childNodes[1];
            d3.select(t).style('font-weight', 'normal');
        });
    tr
        .style('color', 'white')
        .style('border-color', 'white')
        .transition()
        .duration(250)
        .ease('linear')
        .style('border-color', 'black')
        .style('color', 'black');
    tr.append('td')
        .html(function(X, i) {return i == 0 ? 'P' : String.fromCharCode(64+i);})
        .attr('class', 'point');
    tr.append('td').html(function(X, i) {return L1[X[1]]});
    tr.append('td').html(function(X, i) {return L2[X[2]]});
    tr.append('td').html(function(X, i) {return L3[X[3]]});

    // plot
    var points = svg.selectAll('.point').data(Xs)
        .enter()
        .append('g')
        .attr('class', 'point')
        .attr('transform', function(X) {
            return 'translate(' + x(Q(X, A, B)) + ',' + y(P(X, A, B)) + ')'});
    points
        .style('fill-opacity', 1e-6)
        .transition()
        .duration(250)
        .ease('linear')
        .style('fill-opacity', 1);
    points.append('circle')
        .attr('fill', 'black')
        .attr('r', 4);
    points.append('text')
        .attr('dx', 5).attr('dy', 5)
        .attr('dominant-baseline', 'text-before-edge')
        .style('text-anchor', 'begin')
        .style('cursor', 'default')
        .text(function(X, i) {
            return i == 0 ? 'P' : String.fromCharCode(64+i);
        });
}

// CREATE PLOT

var width = 350, height = 280;
var margin = {top: 20, right: 20, bottom: 30, left: 40},
    innerwidth = width - margin.left - margin.right,
    innerheight = height - margin.top - margin.bottom;

var x = d3.scale.linear().domain([0, Qmax]).range([0, innerwidth]);
var y = d3.scale.linear().domain([0, Pmax]).range([innerheight, 0]);

var xaxis = d3.svg.axis().scale(x).orient('bottom').ticks(4);
var yaxis = d3.svg.axis().scale(y).orient('left').ticks(4);

var svg = d3.select('#plot').append('svg')
    .attr('width', width)
    .attr('height', height)
    .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

svg.append('g')
    .attr('class', 'axis')
    .attr('transform', 'translate(0,' + innerheight + ')')
    .call(xaxis)
    .append('text')
        .attr('x', innerwidth)
        .attr('y', -6)
        .style('text-anchor', 'end')
        .text('Quantity of Wool sold per year');
svg.append('g')
    .attr('class', 'axis')
    .call(yaxis)
    .append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', 6)
        .attr('dy', '.71em')
        .style('text-anchor', 'end')
        .text('Price of Wool');

// WRITE TEXT

addPoints(Xs.slice(0, 1));

d3.select('#text')
    .html('Point <b>P</b> represents current price and quantity of wool. ')
    .append('button')
        .text('See historical points')
        .on('click', function() {
            addPoints(Xs);
            d3.select('#text')
                .html('Choose whichever point is in the same <u>demand</u> line as <b>P</b>.');
        });
</script>
</body>
</html>
