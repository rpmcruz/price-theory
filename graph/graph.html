<!DOCTYPE html>
<html>
<head>
    <title>Graphic plot utility</title>
    <style>
        /* layout */

        #wrap { width: 670px; margin: 0 auto; }
        table { display: inline-block; width: 300px; }
        td { border: 1px solid black; }
        table td.point { font-weight: bold; text-align: center; }

        #question { display: inline-block; width: 14em; font-size: small; vertical-align: middle; }
        button { vertical-align: middle; }
        p.text { margin-top: 60px; text-align: justify; }

        canvas { margin-right: 12px; }
    </style>
</head>

<body>
<div id="wrap">
    <canvas id="mycanvas" width="350" height="280"></canvas>

<p class="text">This utility could be used throughout the textbook for interactive plot illustrations.</p>
</div>
</div>

<script src="../utils/mouse.js"></script>
<script>
var canvas = document.getElementById('mycanvas');
var ctx = canvas.getContext('2d');

function Line(fn) {
    this.fn = fn;
    this.dy = 0;
}

Line.prototype.selectable = function() {
    return true;
}

Line.prototype.evaluate = function(x) {
    return 1 - this.fn(x) + this.dy;
}

Line.prototype.draw = function(hover) {
    ctx.beginPath();
    ctx.strokeStyle = hover ? 'blue' : 'black';
    ctx.lineWidth = hover ? 2 : 1;
    ctx.moveTo(0, (1-this.evaluate(0)) * canvas.height);
    var step = 0.1;
    for(var x = step; x <= 1; x += step)
        ctx.lineTo(x * canvas.width, (1-this.evaluate(x)) * canvas.height);
    ctx.stroke();
}

Line.prototype.move = function(dy) {
    this.dy += dy;
}

function Intersection(l0, l1) {
    this.l0 = l0;
    this.l1 = l1;
}

Intersection.prototype.selectable = function() {
    return false;
}

Intersection.prototype.evaluate = function() {
    // to find intersection between lines, we find the root(s) of the difference
    // between the lines: we do that using a very simple numerical method using
    // a very simple search.
    var y0 = l0.evaluate(0) - l1.evaluate(0);
    var step = 0.01;
    for(var x = step; x <= 1; x += step) {
        var y = l0.evaluate(x) - l1.evaluate(x);
        if(Math.sign(y) != Math.sign(y0)) {
            y = (l0.evaluate(x) + l0.evaluate(x-step)) / 2;
            return {x: x, y: y};
        }
    }
    return null;
}

Intersection.prototype.draw = function(hover) {
    var pos = this.evaluate();
    if(pos == null)
        return;
    ctx.beginPath();
    ctx.strokeStyle = 'black';
    ctx.fillStyle = 'white';
    ctx.lineWidth = 2;
    ctx.arc(pos.x * canvas.width, (1-pos.y) * canvas.height, 8, 0, 2*Math.PI);
    ctx.fill();
    ctx.stroke();
}

function Plot() {
    this.objs = [];
    this.hover = null;
    this.pressed = false;
}

Plot.prototype.add = function(obj) {
    this.objs.push(obj);
}

Plot.prototype.draw = function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.beginPath();
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    ctx.moveTo(0, 0);
    ctx.lineTo(0, canvas.height);
    ctx.lineTo(canvas.width, canvas.height);
    ctx.stroke();

    for(var i = 0; i < this.objs.length; i++)
        this.objs[i].draw(this.hover == i);
}

Plot.prototype.over = function(x, y) {
    var minDist = 0.1;
    var minObj = null;
    x /= canvas.width;
    y /= canvas.height;
    for(var i = 0; i < this.objs.length; i++) {
        var obj = this.objs[i];
        if(obj.selectable()) {
            var dist = Math.abs((1-obj.evaluate(x)) - y);
            if(dist < minDist) {
                minObj = i;
                minDist = dist;
            }
        }
    }
    return minObj;
}

var xmouse0 = 0, ymouse0 = 0;

Plot.prototype.mousemove = function(x, y) {
    if(this.pressed) {
        this.objs[this.hover].move(-(y - ymouse0) / canvas.height);
        this.draw();
    }
    else {
        var hover0 = this.hover;
        this.hover = this.over(x, y);
        if(hover0 != this.hover) {
            canvas.style.cursor = this.hover != null ? 'ns-resize' : 'auto';
            this.draw();
        }
    }
}

canvas.addEventListener('mousemove', function(evt) {
    var mouse = getMousePos(canvas, evt);
    plot.mousemove(mouse.x, mouse.y);
    xmouse0 = mouse.x;
    ymouse0 = mouse.y;
});

canvas.addEventListener('mousedown', function(evt) {
    if(plot.hover != null)
        plot.pressed = true;
});

canvas.addEventListener('mouseup', function(evt) {
    plot.pressed = false;
    var mouse = getMousePos(canvas, evt);
    plot.mousemove(mouse.x, mouse.y);
});

canvas.addEventListener('mouseout', function(evt) {
    if(plot.hover != null) {
        plot.hover = null;
        plot.pressed = false;
        plot.draw();
        canvas.style.cursor = 'auto';
    }
});

var plot = new Plot();
var l0 = new Line(function (x) { return x; });
var l1 = new Line(function (x) { return 1-x; });
plot.add(l0);
plot.add(l1);
plot.add(new Intersection(l0, l1));
plot.draw();
</script>

</body>
</html>
